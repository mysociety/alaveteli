<section class="gallery-grid js-gallery-grid" id="gallery-masonry">
  <div class="gallery-grid--card">
    <%= image_tag('access-to-information/placeholder-img-v1.png', alt: _('World map'), :class => "card--image") %>
    <h3 class="card--title">At vero eos et</h3>
    <p class="card--text">At vero eos et accusamus et iusto odio dignissimos ducimus qui blanditiis praesentium voluptatum deleniti atque corrupti quos dolores et quas molestias excepturi sint occaecati cupiditate non provident, similique sunt in culpa qui officia deserunt mollitia animi, id est laborum et dolorum fuga.</p>
    <a href="" class="card--button">Read more</a>
  </div>
  <div class="gallery-grid--card">
    <%= image_tag('access-to-information/placeholder-img-v2.png', alt: _('World map'), :class => "card--image") %>
    <h3 class="card--title">At vero eos et</h3>
    <p class="card--text">At vero eos et accusamus et iusto odio dignissimos ducimus qui blanditiis praesentium voluptatum deleniti atque corrupti quos dolores et quas molestias excepturi sint occaecati cupiditate non provident, similique sunt in culpa qui officia deserunt mollitia animi, id est laborum et dolorum fuga.</p>
    <p class="card--text">At vero eos et accusamus et iusto odio dignissimos ducimus qui blanditiis praesentium voluptatum deleniti atque corrupti quos dolores et quas molestias excepturi sint occaecati cupiditate non provident, similique sunt in culpa qui officia deserunt mollitia animi, id est laborum et dolorum fuga.</p>
    <a href="" class="card--button">Read more</a>
  </div>
  <div class="gallery-grid--card">
    <h3 class="card--title">At vero eos et</h3>
    <p class="card--text">At vero eos et accusamus et iusto odio dignissimos ducimus qui blanditiis praesentium voluptatum deleniti atque corrupti quos dolores et quas molestias excepturi sint occaecati cupiditate non provident, similique sunt in culpa qui officia deserunt mollitia animi, id est laborum et dolorum fuga.</p>
    <a href="" class="card--button">Read more</a>
  </div>
  <div class="gallery-grid--card">
    <h3 class="card--title">At vero eos et At vero eos et At vero eos et</h3>
    <p class="card--text">At vero eos et accusamus et iusto odio dignissimos ducimus qui blanditiis praesentium voluptatum deleniti atque corrupti quos dolores et quas molestias excepturi sint occaecati cupiditate non provident, similique sunt in culpa qui officia deserunt mollitia animi, id est laborum et dolorum fuga. At vero eos et accusamus et iusto odio dignissimos ducimus qui blanditiis praesentium voluptatum deleniti atque corrupti quos dolores et quas molestias excepturi sint occaecati cupiditate non provident, similique sunt in culpa qui officia deserunt mollitia animi, id est laborum et dolorum fuga.</p>
    <a href="" class="card--button">Read more</a>
  </div>
  <div class="gallery-grid--card">
    <h3 class="card--title">At vero eos et</h3>
    <p class="card--text">At vero eos et accusamus et iusto odio dignissimos ducimus qui blanditiis praesentium voluptatum deleniti atque corrupti quos dolores et quas molestias excepturi sint occaecati cupiditate non provident, similique sunt in culpa qui officia deserunt mollitia animi, id est laborum et dolorum fuga.</p>
    <a href="" class="card--button">Read more</a>
  </div>
  <div class="gallery-grid--card">
    <%= image_tag('access-to-information/placeholder-img-v2.png', alt: _('World map'), :class => "card--image") %>
    <h3 class="card--title">At vero eos et</h3>
    <p class="card--text">At vero eos et accusamus et iusto odio dignissimos ducimus qui blanditiis praesentium voluptatum deleniti atque corrupti quos dolores et quas molestias excepturi sint occaecati cupiditate non provident, similique sunt in culpa qui officia deserunt mollitia animi, id est laborum et dolorum fuga.</p>
    <p class="card--text">At vero eos et accusamus et iusto odio dignissimos ducimus qui blanditiis praesentium voluptatum deleniti atque corrupti quos dolores et quas molestias excepturi sint occaecati cupiditate non provident, similique sunt in culpa qui officia deserunt mollitia animi, id est laborum et dolorum fuga.</p>
    <a href="" class="card--button">Read more</a>
  </div>
  <div class="gallery-grid--card">
    <h3 class="card--title">At vero eos et</h3>
    <p class="card--text">At vero eos et accusamus et iusto odio dignissimos ducimus qui blanditiis praesentium voluptatum deleniti atque corrupti quos dolores et quas molestias excepturi sint occaecati cupiditate non provident, similique sunt in culpa qui officia deserunt mollitia animi, id est laborum et dolorum fuga.</p>
    <a href="" class="card--button">Read more</a>
  </div>
  <div class="gallery-grid--card">
    <%= image_tag('access-to-information/placeholder-img-v2.png', alt: _('World map'), :class => "card--image") %>
    <h3 class="card--title">At vero eos et</h3>
    <p class="card--text">At vero eos et accusamus et iusto odio dignissimos ducimus qui blanditiis praesentium voluptatum deleniti atque corrupti quos dolores et quas molestias excepturi sint occaecati cupiditate non provident, similique sunt in culpa qui officia deserunt mollitia animi, id est laborum et dolorum fuga.</p>
    <p class="card--text">At vero eos et accusamus et iusto odio dignissimos ducimus qui blanditiis praesentium voluptatum deleniti atque corrupti quos dolores et quas molestias excepturi sint occaecati cupiditate non provident, similique sunt in culpa qui officia deserunt mollitia animi, id est laborum et dolorum fuga.</p>
    <a href="" class="card--button">Read more</a>
  </div>

</section>

<style>
:root {
  --gallery-card-padding: 1rem;
  --gallery-column-count: 4;
}

/* Base styles */
.gallery-grid {
  padding: 3rem 1rem;
  margin: 0 auto;
  max-width: 90rem;
}

/* Default layout (no-js fallback) - CSS Grid */
.gallery-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
  gap: 1rem;
  align-items: start;
}

.gallery-grid--card {
  background: #fff;
  border-radius: 25px;
  max-width: 300px;
  width: 100%;
  margin: 0 auto;
  padding: var(--gallery-card-padding, 1rem);
  overflow: hidden;
}

/* When JS loads, override to masonry layout */
.js-loaded .js-gallery-grid {
  display: grid;
  grid-template-columns: repeat(var(--gallery-column-count), 1fr);
}

.js-loaded .gallery-grid__column {
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

.js-loaded .js-gallery-grid > .gallery-grid--card {
  display: none; /* Hide original cards that are direct children */
}

.js-loaded .gallery-grid__column .gallery-grid--card {
  display: block; /* Show cards that have been moved into columns */
  max-width: none;
  width: 100%;
  break-inside: avoid;
}

.card--image {
  margin: calc(var(--gallery-card-padding) * -1) calc(var(--gallery-card-padding) * -1) 1rem;
  width: calc(100% + (var(--gallery-card-padding) * 2));
  max-width: calc(100% + (var(--gallery-card-padding) * 2));
}

.card--title {
  margin-top: 0;
}

.card--button {
  display: block;
  text-align: center;
  text-decoration: none;
  background: #a94ca6;
  margin: 1rem calc(var(--gallery-card-padding, 1rem) * -1) calc(var(--gallery-card-padding, 1rem) * -1);
  width: calc(100% + (var(--gallery-card-padding, 1rem) * 2));
  max-width: calc(100% + (var(--gallery-card-padding, 1rem) * 2));
  padding: 0.5rem;
  color: white;
}

.card--button:visited {
  color: white;
}

@media (max-width: 768px) {
  :root {
    --gallery-column-count: 2;
  }
  
  .no-js .gallery-grid {
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  }
}

@media (max-width: 480px) {
  :root {
    --gallery-column-count: 1;
  }
  
  .no-js .gallery-grid {
    grid-template-columns: 1fr;
  }
  
  .no-js .gallery-grid .gallery-grid--card {
    max-width: none;
  }
}

body {
  background-color: #f3e8f3;
}
</style>

<script>
(function() {
  'use strict';
  
  let originalCards = [];
  let lastCount;
  let masonryColumns;
  let galleryElement;

  const createColumns = (count) => {
    // Remove existing columns if any
    const existingColumns = galleryElement.querySelectorAll('.gallery-grid__column');
    existingColumns.forEach(col => col.remove());

    // Create new columns
    masonryColumns = [];
    for (let i = 0; i < count; i++) {
      const column = document.createElement('div');
      column.className = 'gallery-grid__column';
      galleryElement.appendChild(column);
      masonryColumns.push(column);
    }
  };

  const initLayout = () => {
    const columnCount = parseInt(getComputedStyle(galleryElement).getPropertyValue('--gallery-column-count'));
    
    if (columnCount !== lastCount) {
      createColumns(columnCount);

      // Distribute original cards across columns
      originalCards.forEach((card, i) => {
        const targetColumn = masonryColumns[i % columnCount];
        targetColumn.appendChild(card.cloneNode(true));
      });
      
      lastCount = columnCount;
    }
  };

  const debounce = (func, delay) => {
    let timeoutId;
    return () => {
      clearTimeout(timeoutId);
      timeoutId = setTimeout(() => func.apply(this), delay);
    };
  };

  const resizeFunc = debounce(() => {
    initLayout();
  }, 100);

  document.addEventListener('DOMContentLoaded', () => {
    galleryElement = document.getElementById('gallery-masonry');
    if (!galleryElement) return;

    // Collect all original cards
    originalCards = Array.from(galleryElement.querySelectorAll('.gallery-grid--card'));
    
    if (originalCards.length === 0) return;

    // Initialize masonry layout
    initLayout();

    // Add resize listener
    window.addEventListener('resize', resizeFunc, true);
  });
})();
</script>
